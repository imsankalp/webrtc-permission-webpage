<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script  src="./adapter.js"></script>

</head>
<body>
    <h1 id="getLocation" style = 'text-align: center;'>One Card VKYC</h1>
    <video id="local" autoplay></video>
    <p id="giveCamPermission"></p>
    <p id="giveLocPermission"></p>
    <!-- <iframe src="https://webrtc.github.io/samples/src/content/devices/input-output/

    " title="checking" allow="camera; microphone"></iframe> -->

</body>
<script type="text/javascript">

var allPermissions = 0;

  function gotStream(stream) {
    allPermissions +=1;
      window.AudioContext = window.AudioContext || window.webkitAudioContext;
      let audioContext = new AudioContext();

      // Create an AudioNode from the stream
      let mediaStreamSource = audioContext.createMediaStreamSource(stream);

      // Connect it to destination to hear yourself
      // or any other node for processing!
      mediaStreamSource.connect(audioContext.destination);
      let video = document.querySelector('video');
      let videoTracks = stream.getVideoTracks();
      window.stream = stream; // make letiable available to browser console
      video.srcObject = stream;
  }

  function onfail(error) {
      console.log("permission not granted or system don't have media devices."+error.name);
      let showCamPermission = document.getElementById("giveCamPermission");
      showCamPermission.innerText = "Give Safari permission to access your camera and microphone";
  }

  function getLocation() {

      let getLocPermission = document.getElementById("giveLocPermission")
    //Fetch Location
    if (navigator.geolocation) {
      //If location found
      navigator.geolocation.getCurrentPosition(() => {
        console.log("location found");
      allPermissions +=1;
      getLocPermission.innerText = "Loc Permission given";
        
      }, () => {
        getLocPermission.innerText = "Give Permission to Safari Browser to allow location Access.";
      console.log("location NOT found");
      })
    

    } else { 
      //If location not found
      getLocPermission.innerText = "Give Permission to Safari Browser to allow location Access.";
      console.log("location NOT found");
  }

}

function redirectToBank(){
  console.log("redirect");
  setTimeout(() => {
    if(allPermissions == 2){
      window.location.replace("https://www.google.com");
    }
  }, 3000)
  
}



  // navigator.mediaDevices.getUserMedia({audio:true,video:true})
  //   .then((stream) => {
  //     Promise.resolve(gotStream(stream))
  //       .then(() => {
  //         Promise.resolve(getLocation())
  //           .then(() => {
  //             redirectToBank();
  //           })
  //       }) 
  //   })
  //   .catch((error) => {
  //     onfail(error);
  //   });

    navigator.mediaDevices.getUserMedia({audio:true, video:true}, gotStream(stream), onfail(error));
    getLocation();
    if(allPermissions == 2){
      redirectToBank();
    }
  
</script>
</html>
